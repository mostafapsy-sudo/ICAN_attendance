<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… I CAN</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background: linear-gradient(135deg, #004d40, #002f6c);
            color: white;
            font-family: 'Segoe UI', Tahoma, sans-serif;
            text-align: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header-logo {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            z-index: 1000;
            border-radius: 50%; 
            border: 3px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            object-fit: cover; 
            background-color: white;
        }
        .i-can-bg {
            font-size: 100px; font-weight: bold; color: rgba(255, 255, 255, 0.03);
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: -1; pointer-events: none;
        }

        .screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px;
        }

        .hidden { display: none !important; }

        .top-back-btn {
            position: absolute; top: 20px; left: 20px; background: #555; color: white;
            padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer;
            font-size: 16px; font-weight: bold; z-index: 1000;
        }

        .container {
            background: rgba(255, 255, 255, 0.15); padding: 30px; border-radius: 25px;
            backdrop-filter: blur(15px); box-shadow: 0 15px 35px rgba(0,0,0,0.5);
            max-width: 900px; width: 95%; margin: 20px auto; max-height: 80vh; overflow-y: auto;
            position: relative;
        }

        .attendance-buttons-row { display: flex; gap: 15px; width: 100%; margin: 25px 0; }
        .record-btn {
            flex: 1; padding: 20px; border-radius: 15px; color: white; font-weight: bold;
            cursor: pointer; border: none; font-size: 16px; transition: 0.3s;
        }
        .in-btn { background: linear-gradient(135deg, #4CAF50, #2E7D32); }
        .out-btn { background: linear-gradient(135deg, #2196F3, #1976D2); }
        .record-btn:disabled { background: #888; cursor: not-allowed; opacity: 0.6; }

        .main-btn {
            padding: 25px; font-size: 28px; border: none; border-radius: 15px; cursor: pointer;
            font-weight: bold; color: white; width: 100%; max-width: 400px; margin-bottom: 20px;
        }
        .admin-btn { background: linear-gradient(135deg, #9c27b0, #673ab7); }
        .spec-btn { background: linear-gradient(135deg, #2196f3, #00bcd4); }

        .attendance-grid {
            display: grid; grid-template-columns: 0.5fr 1fr 1fr 0.8fr 0.8fr 0.8fr;
            gap: 10px; background: rgba(255, 255, 255, 0.95); color: #333; margin: 10px 0;
            padding: 12px; border-radius: 10px; align-items: center; font-size: 13px;
        }
        .stat-box { background: #eee; padding: 5px; border-radius: 5px; cursor: pointer; }
        .stat-box:hover { background: #ddd; }

        .report-card { background: white; color: #333; padding: 15px; border-radius: 12px; margin-bottom: 10px; text-align: right; line-height: 1.6; }

        input, select { padding: 15px; border-radius: 10px; border: none; width: 80%; max-width: 300px; font-size: 18px; margin: 10px 0; outline: none; }
        .action-btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; background: #4CAF50; color: white; margin: 5px; }

        .settings-trigger {
            position: absolute; bottom: 15px; left: 15px;
            background: rgba(255,255,255,0.2); border: none; border-radius: 50%;
            width: 45px; height: 45px; cursor: pointer; font-size: 22px;
            display: flex; align-items: center; justify-content: center;
        }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none; align-items: center; 
            justify-content: center; z-index: 3000;
        }
        .modal-content { 
            background: #fff; color: #333; padding: 25px; 
            border-radius: 20px; width: 85%; max-width: 350px; 
        }
    </style>
</head>
<body>

    <img src="logo.png" alt="I CAN Logo" class="header-logo">
    <div class="i-can-bg">I CAN</div>

    <div id="mainScreen" class="screen">
        <h1 style="font-size: 50px; margin-bottom: 50px;">I CAN</h1>
        <button class="main-btn admin-btn" onclick="showScreen('adminLoginScreen')">ğŸ‘‘ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
        <button class="main-btn spec-btn" onclick="showScreen('specialistMonthScreen')">ğŸ‘¤ Ø§Ù„Ø£Ø®ØµØ§Ø¦ÙŠ</button>
    </div>

    <div id="adminLoginScreen" class="screen hidden">
        <button class="top-back-btn" onclick="showScreen('mainScreen')">ğŸ”™</button>
        <div class="container">
            <h2>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</h2>
            <input type="password" id="adminPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" inputmode="numeric">
            <br>
            <button class="action-btn" onclick="loginAdmin()">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <div id="adminControlPanel" class="screen hidden">
        <button class="top-back-btn" onclick="showScreen('mainScreen')">ğŸ”™</button>
        <div class="container">
            <h2>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
            <div style="margin: 20px 0;">
                <input type="text" id="newSpecName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯" lang="ar" dir="rtl">
                <button class="action-btn" onclick="addSpecialist()">Ø¥Ø¶Ø§ÙØ©</button>
            </div>
            <div id="specialistsList" style="margin-bottom: 20px;"></div>
            
            <button class="action-btn" style="background:#17a2b8" onclick="viewReports()">ğŸ“Š Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
<button class="action-btn" style="background:#28a745" onclick="exportBackup()">ğŸ“¤ ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© (Backup)</button>
<button class="action-btn" style="background:#ffc107; color:black;" onclick="document.getElementById('importFile').click()">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</button>
<input type="file" id="importFile" style="display:none" accept=".json" onchange="importBackup(event)">
            <button class="action-btn" style="background:#6c757d" onclick="exportDetailedPDF()">ğŸ“‹ Ø­ÙØ¸ Ù†Ø³Ø®Ø© ØªÙØµÙŠÙ„ÙŠØ© (PDF)</button>
            <button class="action-btn" style="background:#f44336" onclick="clearAllData()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            
            <button class="settings-trigger" onclick="toggleModal(true)">âš™ï¸</button>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <h3>âœï¸ ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¯ÙˆÙŠ Ù„Ù„Ø³Ø¬Ù„Ø§Øª</h3>
            <hr style="margin: 10px 0; opacity: 0.2;">
            <label>Ø§Ù„Ø£Ø®ØµØ§Ø¦ÙŠ:</label>
            <select id="selectSpecToEdit" style="width:100%;" onchange="updateDaysDropdown()"></select>
            <label>Ø§Ù„ÙŠÙˆÙ…:</label>
            <select id="selectDayToEdit" style="width:100%;"></select>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <div style="flex: 1;"><label>Ø­Ø¶ÙˆØ±:</label><input type="time" id="editInTime" style="width: 100%;"></div>
                <div style="flex: 1;"><label>Ø§Ù†ØµØ±Ø§Ù:</label><input type="time" id="editOutTime" style="width: 100%;"></div>
            </div>
            <button class="action-btn" style="width: 100%; margin-top: 20px;" onclick="saveAdminCorrection()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
            <button onclick="toggleModal(false)" style="color:red; background:none; border:none; margin-top:10px; cursor:pointer;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <div id="reportScreen" class="screen hidden">
        <button class="top-back-btn" onclick="showScreen('adminControlPanel')">ğŸ”™</button>
        <div class="container">
            <h2>ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>
            <div id="reportContainer" style="margin-top: 20px;"></div>
        </div>
    </div>

    <div id="specialistMonthScreen" class="screen hidden">
        <button class="top-back-btn" onclick="showScreen('mainScreen')">ğŸ”™</button>
        <div class="container">
            <h2>Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±</h2>
            <div id="monthButtons" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px;"></div>
        </div>
    </div>

    <div id="specPassScreen" class="screen hidden">
        <button class="top-back-btn" onclick="showScreen('specialistMonthScreen')">ğŸ”™</button>
        <div class="container">
            <h2>Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡ÙˆÙŠØ©</h2>
            <input type="password" id="specPass" placeholder="Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ">
            <br>
            <button class="action-btn" onclick="verifySpec()">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <div id="attendanceScreen" class="screen hidden">
        <button class="top-back-btn" onclick="showScreen('specialistMonthScreen')">ğŸ”™</button>
        <div class="container">
            <h2 id="monthTitle">ğŸ“…</h2>
            <div style="background: white; color: #333; padding: 10px; border-radius: 10px; margin: 10px 0;">
                <h3>Ø§Ù„Ø£Ø®ØµØ§Ø¦ÙŠ: <span id="currentSpecName"></span></h3>
            </div>
            <div class="attendance-buttons-row">
                <button id="inBtn" class="record-btn in-btn" onclick="recordIn()">Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ±</button>
                <button id="outBtn" class="record-btn out-btn" onclick="recordOut()">Ø³Ø¬Ù„ Ø§Ù†ØµØ±Ø§Ù</button>
            </div>
            <div class="attendance-grid" style="background: #002f6c; color: white;">
                <span>ÙŠÙˆÙ…</span><span>Ø­Ø¶ÙˆØ±</span><span>Ø§Ù†ØµØ±Ø§Ù</span><span>ØªØ£Ø®ÙŠØ±</span><span>Ù…Ø¨ÙƒØ±</span><span>Ø¥Ø¶Ø§ÙÙŠ</span>
            </div>
            <div id="daysList"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA5btGtTXfLti7vipnCgkv0Zy2-ry8lxME",
            authDomain: "anas-attedendence-2.firebaseapp.com",
            databaseURL: "https://anas-attedendence-2-default-rtdb.firebaseio.com",
            projectId: "anas-attedendence-2",
            storageBucket: "anas-attedendence-2.firebasestorage.app",
            messagingSenderId: "474174822973",
            appId: "1:474174822973:web:b7df045425c88270c46854"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let specialists = JSON.parse(localStorage.getItem('ican_specs')) || [];
        let attendance = JSON.parse(localStorage.getItem('ican_att')) || {};
        let timeConfig = { in: "08:30", out: "16:30" };
        let selMonth = new Date().getMonth() + 1, selMonthName = "", selSpec = null;
        let isAdminActive = false;
        const now = new Date();

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            if(id === 'specialistMonthScreen') { loadMonths(); isAdminActive = false; }
            if(id === 'adminControlPanel') { loadSpecsList(); isAdminActive = true; }
        }

        function loadSpecsList() {
            const list = document.getElementById('specialistsList');
            list.innerHTML = specialists.map((s, i) => `
                <div style="background:white; color:#333; padding:10px; margin:5px; border-radius:8px; display:flex; justify-content:space-between; align-items:center;">
                    ${s.name} <button onclick="deleteSpec(${i})" style="color:red; border:none; background:none; cursor:pointer;">Ø­Ø°Ù</button>
                </div>
            `).join('');
        }

        function addSpecialist() {
            const name = document.getElementById('newSpecName').value;
            if(name) {
                const newSpec = { name: name, pass: name + "1" };
                specialists.push(newSpec);
                db.ref('specialists/' + name).set(newSpec);
                localStorage.setItem('ican_specs', JSON.stringify(specialists));
                loadSpecsList();
                document.getElementById('newSpecName').value = "";
            }
        }

        function deleteSpec(i) {
            if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) {
                db.ref('specialists/' + specialists[i].name).remove();
                specialists.splice(i, 1);
                localStorage.setItem('ican_specs', JSON.stringify(specialists));
                loadSpecsList();
            }
        }

        function loginAdmin() {
            if(document.getElementById('adminPassword').value === "1234") showScreen('adminControlPanel');
            else alert("Ø®Ø·Ø£");
        }

        // --- ÙˆØ¸ÙŠÙØ© ØªØµØ¯ÙŠØ± PDF Ø§Ù„ØªÙØµÙŠÙ„ÙŠ ---
        function exportDetailedPDF() {
            let reportMonth = selMonth || (now.getMonth() + 1);
            let element = document.createElement('div');
            element.dir = 'rtl';
            element.style.padding = '10px';

            specialists.forEach((spec) => {
                let totalDelay = 0, totalOver = 0, totalEarly = 0, daysCount = 0;
                const monthData = attendance[spec.name]?.[reportMonth] || {};
                const daysInMonth = new Date(2026, reportMonth, 0).getDate();

                Object.values(monthData).forEach(d => {
                    if(d.in) {
                        daysCount++;
                        totalDelay += parseInt(d.delay || 0);
                        totalEarly += parseInt(d.early || 0);
                        totalOver += parseInt(d.over || 0);
                    }
                });

                let specPage = `
                <div style="page-break-after: always; border: 1px solid #000; padding: 20px; margin-bottom: 20px; color: black; background: white;">
                    <h2 style="text-align: center;">Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ±: ${spec.name}</h2>
                    <p style="text-align: center;">Ø´Ù‡Ø±: ${reportMonth} / 2026</p>
                    <hr>
                    <div style="margin: 15px 0; padding: 10px; background: #eee; border-radius: 8px;">
                        <strong>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:</strong> Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„: ${daysCount} | ØªØ£Ø®ÙŠØ±: ${totalDelay} Ø¯ | Ø§Ù†ØµØ±Ø§Ù Ù…Ø¨ÙƒØ±: ${totalEarly} Ø¯ | Ø¥Ø¶Ø§ÙÙŠ: ${totalOver} Ø¯
                    </div>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px;">
                        <thead>
                            <tr style="background: #f2f2f2;">
                                <th style="border: 1px solid #000; padding: 5px;">Ø§Ù„ÙŠÙˆÙ…</th>
                                <th style="border: 1px solid #000;">Ø­Ø¶ÙˆØ±</th>
                                <th style="border: 1px solid #000;">Ø§Ù†ØµØ±Ø§Ù</th>
                                <th style="border: 1px solid #000;">ØªØ£Ø®ÙŠØ±</th>
                                <th style="border: 1px solid #000;">Ù…Ø¨ÙƒØ±</th>
                                <th style="border: 1px solid #000;">Ø¥Ø¶Ø§ÙÙŠ</th>
                            </tr>
                        </thead>
                        <tbody>`;

                for (let d = 1; d <= daysInMonth; d++) {
                    const day = monthData[d] || {};
                    specPage += `
                        <tr>
                            <td style="border: 1px solid #000; text-align: center;">${d}</td>
                            <td style="border: 1px solid #000; text-align: center;">${day.in || '-'}</td>
                            <td style="border: 1px solid #000; text-align: center;">${day.out || '-'}</td>
                            <td style="border: 1px solid #000; text-align: center;">${day.delay || 0}Ø¯</td>
                            <td style="border: 1px solid #000; text-align: center;">${day.early || 0}Ø¯</td>
                            <td style="border: 1px solid #000; text-align: center;">${day.over || 0}Ø¯</td>
                        </tr>`;
                }

                specPage += `</tbody></table></div>`;
                element.innerHTML += specPage;
            });

            const opt = {
                margin: 0.5,
                filename: `ØªÙ‚Ø±ÙŠØ±_Ø­Ø¶ÙˆØ±_ICAN_${reportMonth}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save();
        }

        // --- Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø¹ØªØ§Ø¯Ø© ---
        function loadMonths() {
            const months = ["ÙŠÙ†Ø§ÙŠØ±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø£Ø¨Ø±ÙŠÙ„", "Ù…Ø§ÙŠÙˆ", "ÙŠÙˆÙ†ÙŠÙˆ", "ÙŠÙˆÙ„ÙŠÙˆ", "Ø£ØºØ³Ø·Ø³", "Ø³Ø¨ØªÙ…Ø¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±"];
            const div = document.getElementById('monthButtons');
            div.innerHTML = months.map((m, i) => `<button class="action-btn" onclick="selMonth=${i+1}; selMonthName='${m}'; showScreen('specPassScreen')">${m}</button>`).join('');
        }

        async function verifySpec() {
            const p = document.getElementById('specPass').value;
            const s = specialists.find(x => x.pass === p);
            if(s) {
                selSpec = s;
                document.getElementById('currentSpecName').textContent = s.name;
                document.getElementById('monthTitle').textContent = "Ø´Ù‡Ø± " + selMonthName;
                showScreen('attendanceScreen');
                loadDays();
            } else alert("Ø®Ø·Ø£");
        }

        function loadDays() {
            const container = document.getElementById('daysList');
            container.innerHTML = "";
            const daysCount = new Date(2026, selMonth, 0).getDate();
            for(let d = 1; d <= daysCount; d++) {
                const data = attendance[selSpec.name]?.[selMonth]?.[d] || {};
                container.innerHTML += `
                    <div class="attendance-grid">
                        <span>${d}</span>
                        <span class="stat-box">${data.in || '-'}</span>
                        <span class="stat-box">${data.out || '-'}</span>
                        <span class="stat-box">${data.delay || 0}Ø¯</span>
                        <span class="stat-box">${data.early || 0}Ø¯</span>
                        <span class="stat-box">${data.over || 0}Ø¯</span>
                    </div>`;
            }
            updateBtns();
        }

        function updateBtns() {
            const d = now.getDate();
            const data = attendance[selSpec.name]?.[selMonth]?.[d] || {};
            document.getElementById('inBtn').disabled = !!data.in;
            document.getElementById('outBtn').disabled = !data.in || !!data.out;
        }

        function recordIn() {
            const t = new Date();
            const time = t.getHours() + ":" + t.getMinutes().toString().padStart(2, '0');
            const limit = new Date(); limit.setHours(8, 30, 0);
            let delay = t > limit ? Math.floor((t - limit) / 60000) : 0;
            saveData(now.getDate(), { in: time, delay: delay });
        }

        function recordOut() {
            const t = new Date();
            const time = t.getHours() + ":" + t.getMinutes().toString().padStart(2, '0');
            const limit = new Date(); limit.setHours(16, 30, 0);
            let early = t < limit ? Math.floor((limit - t) / 60000) : 0;
            let over = t > limit ? Math.floor((t - limit) / 60000) : 0;
            saveData(now.getDate(), { out: time, early: early, over: over });
        }

        function saveData(day, obj) {
            if(!attendance[selSpec.name]) attendance[selSpec.name] = {};
            if(!attendance[selSpec.name][selMonth]) attendance[selSpec.name][selMonth] = {};
            attendance[selSpec.name][selMonth][day] = { ...attendance[selSpec.name][selMonth][day], ...obj };
            db.ref('attendance/' + selSpec.name + '/' + selMonth + '/' + day).update(obj);
            localStorage.setItem('ican_att', JSON.stringify(attendance));
            loadDays();
        }

        function viewReports() {
            showScreen('reportScreen');
            const container = document.getElementById('reportContainer');
            container.innerHTML = "";
            specialists.forEach(spec => {
                let totalDelay = 0, totalOver = 0, totalEarly = 0, daysCount = 0;
                const monthData = attendance[spec.name]?.[selMonth] || {};
                Object.values(monthData).forEach(d => { if(d.in) { daysCount++; totalDelay += (d.delay || 0); totalEarly += (d.early || 0); totalOver += (d.over || 0); } });
                container.innerHTML += `<div class="report-card"><strong>${spec.name}</strong><br>Ø£ÙŠØ§Ù…: ${daysCount} | ØªØ£Ø®ÙŠØ±: ${totalDelay}Ø¯ | Ù…Ø¨ÙƒØ±: ${totalEarly}Ø¯ | Ø¥Ø¶Ø§ÙÙŠ: ${totalOver}Ø¯</div>`;
            });
        }

        function clearAllData() { if(confirm("Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„ØŸ")) { localStorage.clear(); location.reload(); } }
        // ÙˆØ¸ÙŠÙØ© ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
function exportBackup() {
    const backupData = {
        specialists: specialists,
        attendance: attendance,
        timestamp: new Date().toLocaleString()
    };
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData));
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", "ICAN_Backup_" + new Date().toLocaleDateString() + ".json");
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
}

// ÙˆØ¸ÙŠÙØ© Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function importBackup(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            if (confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨ØªØ§Ø±ÙŠØ®: " + (importedData.timestamp || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"))) {
                if (importedData.specialists) {
                    specialists = importedData.specialists;
                    localStorage.setItem('ican_specs', JSON.stringify(specialists));
                }
                if (importedData.attendance) {
                    attendance = importedData.attendance;
                    localStorage.setItem('ican_att', JSON.stringify(attendance));
                }
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ²
                db.ref('/').set({
                    specialists: Array.isArray(importedData.specialists) ? 
                        importedData.specialists.reduce((acc, curr) => { acc[curr.name] = curr; return acc; }, {}) : 
                        importedData.specialists,
                    attendance: importedData.attendance
                }).then(() => {
                    alert("âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­!");
                    location.reload();
                });
            }
        } catch (err) { alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù"); }
    };
    reader.readAsText(file);
}

        function toggleModal(show) {
            document.getElementById('settingsModal').style.display = show ? 'flex' : 'none';
            if(show) {
                const s = document.getElementById('selectSpecToEdit');
                s.innerHTML = specialists.map(x => `<option value="${x.name}">${x.name}</option>`).join('');
                updateDaysDropdown();
            }
        }

        function updateDaysDropdown() {
            const d = document.getElementById('selectDayToEdit');
            const daysCount = new Date(2026, selMonth, 0).getDate();
            d.innerHTML = "";
            for(let i=1; i<=daysCount; i++) d.innerHTML += `<option value="${i}">${i}</option>`;
        }

        function saveAdminCorrection() {
            const name = document.getElementById('selectSpecToEdit').value;
            const day = document.getElementById('selectDayToEdit').value;
            const inT = document.getElementById('editInTime').value;
            const outT = document.getElementById('editOutTime').value;
            // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙŠØ¯ÙˆÙŠ (Ù…Ø¨Ø³Ø· Ù‡Ù†Ø§ Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø­Ø©)
            if(inT) saveDataManual(name, day, { in: inT });
            if(outT) saveDataManual(name, day, { out: outT });
            alert("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„");
            toggleModal(false);
        }

        function saveDataManual(name, day, obj) {
            if(!attendance[name]) attendance[name] = {};
            if(!attendance[name][selMonth]) attendance[name][selMonth] = {};
            attendance[name][selMonth][day] = { ...attendance[name][selMonth][day], ...obj };
            db.ref('attendance/' + name + '/' + selMonth + '/' + day).update(obj);
            localStorage.setItem('ican_att', JSON.stringify(attendance));
        }

        db.ref('/').on('value', (s) => {
            const d = s.val();
            if(d) {
                if(d.specialists) specialists = Object.values(d.specialists);
                if(d.attendance) attendance = d.attendance;
            }
        });
    </script>
</body>
</html>
