<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… I CAN</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background: linear-gradient(135deg, #004d40, #002f6c);
            color: white;
            font-family: 'Segoe UI', Tahoma, sans-serif;
            text-align: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header-logo {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            z-index: 1000;
            border-radius: 50%; 
            border: 3px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            object-fit: cover; 
            background-color: white;
        }
        .i-can-bg {
            font-size: 100px; font-weight: bold; color: rgba(255, 255, 255, 0.03);
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: -1; pointer-events: none;
        }

        .screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px;
        }

        .hidden { display: none !important; }

        .top-back-btn {
            position: absolute; top: 20px; left: 20px; background: #555; color: white;
            padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer;
            font-size: 16px; font-weight: bold; z-index: 1000;
        }

        .container {
            background: rgba(255, 255, 255, 0.15); padding: 30px; border-radius: 25px;
            backdrop-filter: blur(15px); box-shadow: 0 15px 35px rgba(0,0,0,0.5);
            max-width: 900px; width: 95%; margin: 20px auto; max-height: 80vh; overflow-y: auto;
            position: relative;
        }

        .attendance-buttons-row { display: flex; gap: 15px; width: 100%; margin: 25px 0; }
        .record-btn {
            flex: 1; padding: 20px; border-radius: 15px; color: white; font-weight: bold;
            cursor: pointer; border: none; font-size: 16px; transition: 0.3s;
        }
        .in-btn { background: linear-gradient(135deg, #4CAF50, #2E7D32); }
        .out-btn { background: linear-gradient(135deg, #2196F3, #1976D2); }
        .record-btn:disabled { background: #888; cursor: not-allowed; opacity: 0.6; }

        .main-btn {
            padding: 25px; font-size: 28px; border: none; border-radius: 15px; cursor: pointer;
            font-weight: bold; color: white; width: 100%; max-width: 400px; margin-bottom: 20px;
        }
        .admin-btn { background: linear-gradient(135deg, #9c27b0, #673ab7); }
        .spec-btn { background: linear-gradient(135deg, #2196f3, #00bcd4); }

        .attendance-grid {
            display: grid; grid-template-columns: 0.5fr 1fr 1fr 0.8fr 0.8fr 0.8fr;
            gap: 10px; background: rgba(255, 255, 255, 0.95); color: #333; margin: 10px 0;
            padding: 12px; border-radius: 10px; align-items: center; font-size: 13px;
        }
        .stat-box { background: #eee; padding: 5px; border-radius: 5px; cursor: pointer; }
        .stat-box:hover { background: #ddd; }

        .report-card { background: white; color: #333; padding: 15px; border-radius: 12px; margin-bottom: 10px; text-align: right; line-height: 1.6; }

        input { padding: 15px; border-radius: 10px; border: none; width: 80%; max-width: 300px; font-size: 18px; margin: 10px 0; outline: none; }
        .action-btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; background: #4CAF50; color: white; }

        .settings-trigger {
            position: absolute; bottom: 15px; left: 15px;
            background: rgba(255,255,255,0.2); border: none; border-radius: 50%;
            width: 45px; height: 45px; cursor: pointer; font-size: 22px;
            display: flex; align-items: center; justify-content: center;
        }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none; align-items: center; 
            justify-content: center; z-index: 3000;
        }
        .modal-content { 
            background: #fff; color: #333; padding: 25px; 
            border-radius: 20px; width: 85%; max-width: 350px; 
        }
    </style>
</head>
<body>

    <img src="logo.png" alt="I CAN Logo" class="header-logo">
    <div class="i-can-bg">I CAN</div>

    <div id="mainScreen" class="screen">
        <h1 style="font-size: 50px; margin-bottom: 50px;">I CAN</h1>
        <button class="main-btn admin-btn" onclick="showScreen('adminLoginScreen')">ğŸ‘‘ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
        <button class="main-btn spec-btn" onclick="showScreen('specialistMonthScreen')">ğŸ‘¤ Ø§Ù„Ø£Ø®ØµØ§Ø¦ÙŠ</button>
    </div>

    <div id="adminLoginScreen" class="screen hidden">
        <button class="top-back-btn" onclick="showScreen('mainScreen')">ğŸ”™</button>
        <div class="container">
            <h2>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</h2>
            <input type="password" id="adminPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" inputmode="numeric">
            <br>
            <button class="action-btn" onclick="loginAdmin()">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <div id="adminControlPanel" class="screen hidden">
        <button class="top-back-btn" onclick="showScreen('mainScreen')">ğŸ”™</button>
        <div class="container">
            <h2>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
            <div style="margin: 20px 0;">
                <input type="text" id="newSpecName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯" lang="ar" dir="rtl" spellcheck="false" autocomplete="off">
                <button class="action-btn" onclick="addSpecialist()">Ø¥Ø¶Ø§ÙØ©</button>
            </div>
            <div id="specialistsList" style="margin-bottom: 20px;"></div>
            <button class="action-btn" style="background:#17a2b8" onclick="viewReports()">ğŸ“Š Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
            <button class="action-btn" style="background:#f44336" onclick="clearAllData()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            <button class="settings-trigger" onclick="toggleModal(true)">âš™ï¸</button>
        </div>
    </div>

    <div id="settingsModal" class="modal">
    <div class="modal-content" style="max-width: 450px;">
        <h3>âœï¸ ØªØ¹Ø¯ÙŠÙ„ ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù</h3>
        <hr style="margin: 10px 0; opacity: 0.2;">
        
        <label>1. Ø§Ø®ØªØ± Ø§Ù„Ø£Ø®ØµØ§Ø¦ÙŠ:</label>
        <select id="selectSpecToEdit" style="padding:10px; width:100%; border-radius:8px; margin:10px 0;" onchange="updateDaysDropdown()">
            <option value="">-- Ø§Ø®ØªØ± --</option>
        </select>

        <label>2. Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ…:</label>
        <select id="selectDayToEdit" style="padding:10px; width:100%; border-radius:8px; margin:10px 0;">
            </select>

        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <div style="flex: 1;">
                <label>ÙˆÙ‚Øª Ø§Ù„Ø­Ø¶ÙˆØ±:</label>
                <input type="time" id="editInTime" style="width: 100%;">
            </div>
            <div style="flex: 1;">
                <label>ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØµØ±Ø§Ù:</label>
                <input type="time" id="editOutTime" style="width: 100%;">
            </div>
        </div>

        <button class="action-btn" style="width: 100%; margin-top: 20px;" onclick="saveAdminCorrection()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨</button>
        <button onclick="toggleModal(false)" style="background:none; border:none; color:red; margin-top:15px; cursor:pointer; width:100%;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>
    <div id="reportScreen" class="screen hidden">
        <button class="top-back-btn" onclick="showScreen('adminControlPanel')">ğŸ”™</button>
        <div class="container">
            <h2>ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>
            <div id="reportContainer" style="margin-top: 20px;"></div>
        </div>
    </div>

    <div id="specialistMonthScreen" class="screen hidden">
        <button class="top-back-btn" onclick="showScreen('mainScreen')">ğŸ”™</button>
        <div class="container">
            <h2>Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±</h2>
            <div id="monthButtons" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px;"></div>
        </div>
    </div>

    <div id="specPassScreen" class="screen hidden">
        <button class="top-back-btn" onclick="showScreen('specialistMonthScreen')">ğŸ”™</button>
        <div class="container">
            <h2>Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡ÙˆÙŠØ©</h2>
            <input type="password" id="specPass" placeholder="Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ" lang="ar" dir="rtl" autocomplete="off">
            <br>
            <button class="action-btn" onclick="verifySpec()">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <div id="attendanceScreen" class="screen hidden">
        <button class="top-back-btn" onclick="showScreen('specialistMonthScreen')">ğŸ”™</button>
        <div class="container">
            <h2 id="monthTitle">ğŸ“…</h2>
            <div style="background: white; color: #333; padding: 10px; border-radius: 10px; margin: 10px 0;">
                <h3>Ø§Ù„Ø£Ø®ØµØ§Ø¦ÙŠ: <span id="currentSpecName"></span></h3>
            </div>
            <div class="attendance-buttons-row">
                <button id="inBtn" class="record-btn in-btn" onclick="recordIn()">Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ±</button>
                <button id="outBtn" class="record-btn out-btn" onclick="recordOut()">Ø³Ø¬Ù„ Ø§Ù†ØµØ±Ø§Ù</button>
            </div>
            <div class="attendance-grid" style="background: #002f6c; color: white;">
                <span>ÙŠÙˆÙ…</span><span>Ø­Ø¶ÙˆØ±</span><span>Ø§Ù†ØµØ±Ø§Ù</span><span>ØªØ£Ø®ÙŠØ±</span><span>Ù…Ø¨ÙƒØ±</span><span>Ø¥Ø¶Ø§ÙÙŠ</span>
            </div>
            <div id="daysList"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA5btGtTXfLti7vipnCgkv0Zy2-ry8lxME",
            authDomain: "anas-attedendence-2.firebaseapp.com",
            databaseURL: "https://anas-attedendence-2-default-rtdb.firebaseio.com",
            projectId: "anas-attedendence-2",
            storageBucket: "anas-attedendence-2.firebasestorage.app",
            messagingSenderId: "474174822973",
            appId: "1:474174822973:web:b7df045425c88270c46854",
            measurementId: "G-PPPPNRCP0R"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let specialists = JSON.parse(localStorage.getItem('ican_specs')) || [];
        let attendance = JSON.parse(localStorage.getItem('ican_att')) || {};
        let timeConfig = JSON.parse(localStorage.getItem('ican_time_config')) || { in: "08:30", out: "16:30" };
        let selMonth = null, selMonthName = "", selSpec = null;
        let isAdminActive = false;
        const now = new Date();

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            if(id === 'specialistMonthScreen') { loadMonths(); isAdminActive = false; }
            if(id === 'adminControlPanel') { loadSpecsList(); isAdminActive = true; }
        }

        // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙŠØ§Ù… Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø£Ø®ØµØ§Ø¦ÙŠ Ù…Ø¹ÙŠÙ† Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ±Ø³
function updateDaysDropdown() {
    const daySelect = document.getElementById('selectDayToEdit');
    daySelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ… --</option>';
    const daysCount = new Date(2026, selMonth || now.getMonth()+1, 0).getDate();
    for(let i=1; i<=daysCount; i++) {
        daySelect.innerHTML += `<option value="${i}">ÙŠÙˆÙ… ${i}</option>`;
    }
}

// ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø£Ø®ØµØ§Ø¦ÙŠÙŠÙ†
function toggleModal(show) {
    const modal = document.getElementById('settingsModal');
    modal.style.display = show ? 'flex' : 'none';
    if(show) {
        const select = document.getElementById('selectSpecToEdit');
        select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø£Ø®ØµØ§Ø¦ÙŠ --</option>';
        specialists.forEach(s => {
            select.innerHTML += `<option value="${s.name}">${s.name}</option>`;
        });
        updateDaysDropdown();
    }
}

// Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©: Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ù…Ù† Ø§Ù„ØªØ±Ø³
function saveAdminCorrection() {
    const specName = document.getElementById('selectSpecToEdit').value;
    const day = document.getElementById('selectDayToEdit').value;
    const newIn = document.getElementById('editInTime').value;
    const newOut = document.getElementById('editOutTime').value;

    if(!specName || !day) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø®ØµØ§Ø¦ÙŠ ÙˆØ§Ù„ÙŠÙˆÙ…");

    if(!attendance[specName]) attendance[specName] = {};
    if(!attendance[specName][selMonth]) attendance[specName][selMonth] = {};
    if(!attendance[specName][selMonth][day]) attendance[specName][selMonth][day] = {};

    let dayData = attendance[specName][selMonth][day];
    const customTimes = JSON.parse(localStorage.getItem('ican_spec_custom_times')) || {};
    const activeTime = customTimes[specName] || timeConfig;

    // 1. ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„ØªØ£Ø®ÙŠØ±
    if(newIn) {
        dayData.in = newIn;
        const [h, m] = activeTime.in.split(':');
        const [nh, nm] = newIn.split(':');
        const limit = new Date(2026, 0, 1, parseInt(h), parseInt(m));
        const entry = new Date(2026, 0, 1, parseInt(nh), parseInt(nm));
        dayData.delay = entry > limit ? Math.floor((entry - limit) / 60000) : 0;
    }

    // 2. ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ù†ØµØ±Ø§Ù ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ/Ø§Ù„Ù…Ø¨ÙƒØ±
    if(newOut) {
        dayData.out = newOut;
        const [h, m] = activeTime.out.split(':');
        const [nh, nm] = newOut.split(':');
        const limit = new Date(2026, 0, 1, parseInt(h), parseInt(m));
        const exit = new Date(2026, 0, 1, parseInt(nh), parseInt(nm));
        dayData.early = exit < limit ? Math.floor((limit - exit) / 60000) : 0;
        dayData.over = exit > limit ? Math.floor((exit - limit) / 60000) : 0;
    }

    // 3. Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
    localStorage.setItem('ican_att', JSON.stringify(attendance));
    db.ref('attendance/' + specName + '/' + selMonth + '/' + day).set(dayData)
    .then(() => {
        alert(`âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¬Ù„ ${specName} Ù„ÙŠÙˆÙ… ${day} Ø¨Ù†Ø¬Ø§Ø­`);
        if(typeof loadDays === "function" && selSpec && selSpec.name === specName) loadDays();
        toggleModal(false);
    });
}

        function loginAdmin() {
            if(document.getElementById('adminPassword').value === "1234") showScreen('adminControlPanel');
            else alert("Ø®Ø·Ø£ ÙÙŠ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±");
        }

        function loadSpecsList() {
            const list = document.getElementById('specialistsList');
            list.innerHTML = specialists.map((s, i) => `
                <div style="background:white; color:#333; padding:10px; margin:5px; border-radius:8px; display:flex; justify-content:space-between; align-items:center;">
                    ${s.name} <button onclick="deleteSpec(${i})" style="color:red; border:none; background:none; cursor:pointer; font-weight:bold;">Ø­Ø°Ù</button>
                </div>
            `).join('');
        }

        function addSpecialist() {
            const name = document.getElementById('newSpecName').value;
            if(name) {
                const newSpec = { name: name, pass: name + "1" };
                specialists.push(newSpec);
                db.ref('specialists/' + name).set(newSpec);
                localStorage.setItem('ican_specs', JSON.stringify(specialists));
                loadSpecsList();
                document.getElementById('newSpecName').value = "";
            }
        }

        function deleteSpec(i) {
            if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø£Ø®ØµØ§Ø¦ÙŠØŸ")) { 
                const name = specialists[i].name;
                db.ref('specialists/' + name).remove();
                specialists.splice(i, 1); 
                localStorage.setItem('ican_specs', JSON.stringify(specialists)); 
                loadSpecsList(); 
            }
        }

        async function verifySpec() {
            const p = document.getElementById('specPass').value;
            const s = specialists.find(x => x.pass === p);
            if(s) {
                selSpec = s;
                document.getElementById('currentSpecName').textContent = s.name;
                document.getElementById('monthTitle').textContent = "Ø´Ù‡Ø± " + selMonthName;
                showScreen('attendanceScreen');
                loadDays();
            } else alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±Ù…Ø²");
        }

        // --- Ø³Ù„Ø·Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ---
// --- ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù…Ø¯ÙŠØ±: ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ---
function editTime(day, field) {
    if(!isAdminActive) return;
    
    // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if(!attendance[selSpec.name]) attendance[selSpec.name] = {};
    if(!attendance[selSpec.name][selMonth]) attendance[selSpec.name][selMonth] = {};
    if(!attendance[selSpec.name][selMonth][day]) attendance[selSpec.name][selMonth][day] = {};

    let dayData = attendance[selSpec.name][selMonth][day];
    let promptMsg = field === 'in' ? 'Ø£Ø¯Ø®Ù„ ÙˆÙ‚Øª Ø§Ù„Ø­Ø¶ÙˆØ± (Ù…Ø«Ø§Ù„ 08:30):' : 'Ø£Ø¯Ø®Ù„ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØµØ±Ø§Ù (Ù…Ø«Ø§Ù„ 16:30):';
    let newVal = prompt(promptMsg, dayData[field] || "");
    
    if(newVal !== null && newVal !== "") {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ÙƒØªÙˆØ¨
        dayData[field] = newVal;

        // Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø±Ø³Ù…ÙŠØ©
        const customTimes = JSON.parse(localStorage.getItem('ican_spec_custom_times')) || {};
        const activeTime = customTimes[selSpec.name] || timeConfig;
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø´Ø§Ù…Ù„
        if (field === 'in') {
            const [h, m] = activeTime.in.split(':');
            const [nh, nm] = newVal.split(':');
            const limit = new Date(2026, 0, 1, parseInt(h), parseInt(m));
            const entry = new Date(2026, 0, 1, parseInt(nh), parseInt(nm));
            dayData.delay = entry > limit ? Math.floor((entry - limit) / 60000) : 0;
        } 
        else if (field === 'out') {
            const [h, m] = activeTime.out.split(':');
            const [nh, nm] = newVal.split(':');
            const limit = new Date(2026, 0, 1, parseInt(h), parseInt(m));
            const exit = new Date(2026, 0, 1, parseInt(nh), parseInt(nm));
            dayData.early = exit < limit ? Math.floor((limit - exit) / 60000) : 0;
            dayData.over = exit > limit ? Math.floor((exit - limit) / 60000) : 0;
        }

        // Ø­ÙØ¸ ÙˆØ­Ø±Øµ Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙŠ Firebase
        localStorage.setItem('ican_att', JSON.stringify(attendance));
        db.ref('attendance/' + selSpec.name + '/' + selMonth + '/' + day).set(dayData)
        .then(() => {
            loadDays(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø£Ù…Ø§Ù…Ùƒ
            alert("âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª");
        });
    }
}

        function loadDays() {
            const container = document.getElementById('daysList');
            container.innerHTML = "";
            const daysCount = new Date(2026, selMonth, 0).getDate();
            for(let d = 1; d <= daysCount; d++) {
                const data = (attendance[selSpec.name] && attendance[selSpec.name][selMonth]) ? attendance[selSpec.name][selMonth][d] || {} : {};
                container.innerHTML += `
                    <div class="attendance-grid">
                        <span>${d}</span>
                        <span class="stat-box" onclick="editTime(${d}, 'in')">${data.in || '-'}</span>
                        <span class="stat-box" onclick="editTime(${d}, 'out')">${data.out || '-'}</span>
                        <span class="stat-box" onclick="editTime(${d}, 'delay')">${data.delay || 0}Ø¯</span>
                        <span class="stat-box" onclick="editTime(${d}, 'early')">${data.early || 0}Ø¯</span>
                        <span class="stat-box" onclick="editTime(${d}, 'over')">${data.over || 0}Ø¯</span>
                    </div>`;
            }
            updateBtns();
        }

        function updateBtns() {
            const d = now.getDate();
            const data = (attendance[selSpec.name] && attendance[selSpec.name][selMonth]) ? attendance[selSpec.name][selMonth][d] || {} : {};
            document.getElementById('inBtn').disabled = !!data.in;
            document.getElementById('outBtn').disabled = !data.in || !!data.out;
        }

        function recordIn() {
            const t = new Date();
            const time = t.getHours() + ":" + t.getMinutes().toString().padStart(2, '0');
            const customTimes = JSON.parse(localStorage.getItem('ican_spec_custom_times')) || {};
            const activeTime = customTimes[selSpec.name] || timeConfig;
            const [h, m] = activeTime.in.split(':');
            const limit = new Date(); limit.setHours(h, m, 0);
            let delay = t > limit ? Math.floor((t - limit) / 60000) : 0;
            saveData(now.getDate(), { in: time, delay: delay });
        }

        function recordOut() {
            const t = new Date();
            const time = t.getHours() + ":" + t.getMinutes().toString().padStart(2, '0');
            const customTimes = JSON.parse(localStorage.getItem('ican_spec_custom_times')) || {};
            const activeTime = customTimes[selSpec.name] || timeConfig;
            const [h, m] = activeTime.out.split(':');
            const limit = new Date(); limit.setHours(h, m, 0);
            let early = t < limit ? Math.floor((limit - t) / 60000) : 0;
            let over = t > limit ? Math.floor((t - limit) / 60000) : 0;
            saveData(now.getDate(), { out: time, early: early, over: over });
        }

        function saveData(day, obj) {
            if(!attendance[selSpec.name]) attendance[selSpec.name] = {};
            if(!attendance[selSpec.name][selMonth]) attendance[selSpec.name][selMonth] = {};
            attendance[selSpec.name][selMonth][day] = { ...attendance[selSpec.name][selMonth][day], ...obj };
            db.ref('attendance/' + selSpec.name + '/' + selMonth + '/' + day).update(obj);
            localStorage.setItem('ican_att', JSON.stringify(attendance));
            loadDays();
            alert("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø©");
        }

        function loadMonths() {
            const months = ["ÙŠÙ†Ø§ÙŠØ±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø£Ø¨Ø±ÙŠÙ„", "Ù…Ø§ÙŠÙˆ", "ÙŠÙˆÙ†ÙŠÙˆ", "ÙŠÙˆÙ„ÙŠÙˆ", "Ø£ØºØ³Ø·Ø³", "Ø³Ø¨ØªÙ…Ø¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±"];
            const div = document.getElementById('monthButtons');
            div.innerHTML = "";
            months.forEach((m, i) => {
                const b = document.createElement('button');
                b.className = "action-btn";
                b.style.background = (i + 1 === now.getMonth() + 1) ? "#f39c12" : "#2196f3";
                b.textContent = m;
                b.onclick = () => { selMonth = i + 1; selMonthName = m; showScreen('specPassScreen'); };
                div.appendChild(b);
            });
        }

        function viewReports() {
    showScreen('reportScreen');
    const container = document.getElementById('reportContainer');
    container.innerHTML = "";
    
    // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù„ÙŠ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙØ§ØªØ­Ø§Ù‡ Ø­Ø§Ù„ÙŠØ§Ù‹
    let reportMonth = selMonth || (now.getMonth() + 1);
    
    specialists.forEach(spec => {
        let totalDelay = 0, totalOver = 0, daysCount = 0;
        
        // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ÙƒØ§Ø¦Ù† Ø§Ù„Ù…Ø­Ù„ÙŠ Ø§Ù„Ù…Ø­Ø¯Ø«
        const monthData = (attendance[spec.name] && attendance[spec.name][reportMonth]) ? attendance[spec.name][reportMonth] : {};
        
        Object.keys(monthData).forEach(dayKey => {
            const d = monthData[dayKey];
            if(d.in) {
                daysCount++;
                totalDelay += parseInt(d.delay || 0);
                totalOver += parseInt(d.over || 0);
            }
        });

        container.innerHTML += `
            <div class="report-card">
                <strong>ğŸ‘¤ Ø§Ù„Ø£Ø®ØµØ§Ø¦ÙŠ: ${spec.name}</strong><br>
                ğŸ“… Ø´Ù‡Ø±: ${reportMonth} | Ø¹Ù…Ù„: ${daysCount} ÙŠÙˆÙ…<br>
                â° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ£Ø®ÙŠØ±: ${totalDelay} Ø¯Ù‚ÙŠÙ‚Ø©<br>
                â• Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ: ${totalOver} Ø¯Ù‚ÙŠÙ‚Ø©
            </div>`;
    });
}

        function clearAllData() { if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) { localStorage.clear(); location.reload(); } }

        db.ref('/').on('value', (snapshot) => {
            const data = snapshot.val();
            if(data) {
                if(data.specialists) {
                    specialists = Object.values(data.specialists);
                    localStorage.setItem('ican_specs', JSON.stringify(specialists));
                }
                if(data.attendance) {
                    attendance = data.attendance;
                    localStorage.setItem('ican_att', JSON.stringify(attendance));
                }
                if(isAdminActive) loadSpecsList();
            }
        });
    </script>
</body>
</html>
